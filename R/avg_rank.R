#' Compute the Average Rank of All Items
#'
#' This function calculates the average rank for the data frame that contains
#' ranking data. It can be used for both long- and wide-type data frames.
#'
#' @param x A data frame that contains rankings of items.
#' @param rankings The name of the column that contains the rankings.
#' Defaults to NULL, which means that the function will look for a data frame
#' with two columns, "item" and "rank".
#' @param items The name of the column that contains the items' names, or,
#' in case of a wide file, the item names in the reference choice set.
#' Defaults to NULL.
#' @param type The type of the data frame.
#' It defaults to \code{"long"}, which means that the data frame is in
#' the long format, presumably generated by \code{rank_longer()}.
#' If the data frame is in the wide format, it should be set to \code{"wide"}.
#' This only accepts a data frame with a single ranking variable that
#' contains rankings, and the rankings should be in the form of a string
#' such as \code{"123"}.
#'
#' @return A data frame with the average rank of each item in the
#' reference choice set.
#'
#' @importFrom dplyr group_by summarise across everything
#' @importFrom tidyr pivot_longer
#' @importFrom stringr str_split
#' @importFrom magrittr %>%
#' @importFrom rlang !!
#' @importFrom tidyselect all_of
#' @importFrom stats sd
#'
#' @examples
#' x <- data.frame(
#'   id = c("Bernie", "Yuki", "Silvia"),
#'   rank = c("123", "321", "213")
#' )
#' avg_rank(x, "rank", type = "wide")
#' avg_rank(x, "rank", type = "wide", items = c("Money", "Power", "Respect"))
#'
#' y <- data.frame(rank = c("123", "321", "213"))
#' avg_rank(y, "rank", type = "wide")
#' z <- rank_longer(
#'   y,
#'   cols = "rank", id = "id",
#'   reference = c("Money", "Power", "Respect")
#' )
#' avg_rank(z, "ranking", items = "item_name")
#'
#' ## Example output from item_to_rank
#' x <- data.frame(
#'   item = c("a", "b", "c", "a", "b", "c", "a", "b", "c"),
#'   rank = c(3L, 1L, 2L, 1L, 2L, 3L, 3L, 2L, 1L)
#' )
#' avg_rank(x)
#'
#' @export

avg_rank <- function(x,
                     rankings = NULL,
                     items = NULL,
                     type = "long") {
  ## Suppress "no visible binding for global variable" warnings
  name <- NULL

  ## Use the output from `item_to_rank` without having to specify input.
  if (
    is.null(rankings) & is.null(items) &
    ncol(x) == 2 & ("rank" %in% names(x)) & ("item" %in% names(x))
  ) {
    rankings <- "rank"
    items <- "item"
  }

  if (is.null(rankings) & type == "wide" & ("rank" %in% names(x))) {
    rankings <- "rank"
  }

  if (is.null(rankings) & !("rank" %in% names(x))) {
    stop("The rankings variable must be specified.")
  }

  ## What is the J?
  J <- max(nchar(x[[rankings]]))

  ## Class sanity checks
  if (!("data.frame" %in% class(x))) {
    stop("x must be a data frame.")
  }
  if (!("character" %in% class(rankings))) {
    stop("'rankings' must be a character.")
  }

  ## Sanity checks for "rankings" and "items" arguments.
  if (!(rankings %in% colnames(x))) {
    stop("The rankings variable is not contained in the given data frame.")
  }
  if (!is.null(items)) {
    if (!("character" %in% class(items))) {
      stop("'items' must be a character.")
    }
    if (type == "wide") {
      if (J < length(items)) {
        stop(
          paste0(
            "The number of reference choice set's elements in the items ",
            "variable does not match the number of items ranked."
          )
        )
      }
    } else {
      if (!(items %in% colnames(x))) {
        stop("The items variable is not contained in the given data frame.")
      }
    }
  } else {
    if (type == "long") {
      stop("If long data frame, the items variable must be specified.")
    }
  }

  ## Depending on whether it's a long- or wide-type data frame,
  ## treat differently
  if (type == "long") {
    out <- x %>%
      group_by(!!as.name(items))
  } else if (type == "wide") {
    if (is.null(items)) {
      ## Just use the ranking positions to identify the items
      out <- x %>%
        separate(!!as.name(rankings), sep = seq(J), into = ordinal_seq(J)) %>%
        mutate(across(all_of(ordinal_seq(J)), as.numeric)) %>%
        pivot_longer(
          all_of(ordinal_seq(J)),
          names_to = "name",
          values_to = "rankings"
        )
    } else {
      ## Use the items variable as item names
      out <- x %>%
        separate(!!as.name(rankings), sep = seq(J), into = items) %>%
        mutate(across(all_of(items), as.numeric)) %>%
        pivot_longer(
          all_of(items),
          names_to = "name",
          values_to = "rankings"
        )
    }
    rankings <- "rankings"
    out <- out %>%
      group_by(name)
  } else {
    stop("The type must be either 'long' or 'wide'.")
  }

  ## Compute the average rank
  out <- out %>%
    summarise(
      mean = mean(!!as.name(rankings), na.rm = TRUE),
      se = sd(!!as.name(rankings), na.rm = TRUE) / sqrt(nrow(x))
    )
  return(out)
}
